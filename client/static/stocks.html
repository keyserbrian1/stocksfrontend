<!DOCTYPE html>
<html ng-app="stocks">

<head>
  <meta charset="utf-8">
  <title> Index </title>
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.7/angular.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.7/angular-route.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.7/angular-cookies.js"></script>
  <script type ="text/javascript" src="/socket.io/socket.io.js"></script>

  <link rel="stylesheet" href="/cdn/bootstrap/dist/css/bootstrap-min.css" media="screen" title="no title">
  <script src="/cdn/at-table/dist/angular-table.min.js"></script>



  <script type="text/javascript">
  /* global io */
  var stocks = angular.module("stocks", ["ngRoute", "ngCookies"]);

  stocks.config(function($routeProvider){
    $routeProvider
    .when("/", {
      templateUrl: "partials/companies.html"
    })
    .when("/logout", {
      templateUrl: "partials/logout.html"
    })
    .when("/:symbol", {
      templateUrl: "partials/company.html"
    })
    .otherwise({
      redirectTo: "/"
    });
  });

  stocks.factory("companyFactory", ["$http", function($http){
    var factory = {
      getGlobalData: function(){
        return $http.get("/companyData");
      },
      getUserData: function(){
        return $http.get("/userData");
      },
      placeOrder: function(order){
        return $http.post("/order", order);
      }
    };
    return factory;
  }]);

  stocks.controller("outerController", ["$scope", "companyFactory", function($scope, companyFactory){
    $scope.socket = io.connect();
    $scope.socket.on("globalUpdate", function(data){
      $scope.companyData[data.response.symbol] = data.response.newCompanyData;
      companyFactory.getUserData().then(function(data){
        $scope.userData = data;
      }).catch(function(err){
        console.err("User data failed",err);
      });
    });
    $scope.home = {};
    companyFactory.getGlobalData().then(function(data){
      $scope.companyData = data;
    }).catch(function(err){
      console.err("Global data failed",err);
    });
    companyFactory.getUserData().then(function(data){
      $scope.userData = data;
    }).catch(function(err){
      console.err("User data failed",err);
    });
  }]);
  stocks.controller("mainController", ["$scope", function($scope){
    $scope.home.shouldDisplay = false;
    $scope.socket.emit("main");
    $scope.updateCompany = function(){/*do nothing, eat accidental call*/};
  }]);
  stocks.controller("companyController", ["$scope", "$routeParams", "companyFactory", "$route", function($scope, $routeParams, companyFactory, $route){
    $scope.socket.on("companyUpdate", function(data){
      $scope.updateCompany(data);
    });
    $scope.symbol = $routeParams.symbol;
    $scope.socket.emit("company", $scope.symbol);
    $scope.on("$routeChangeStart", function(){
      $scope.socket.off("companyUpdate");
    });
    $scope.data = false;
    $scope.socket.emit("company", $scope.symbol);
    $scope.updateCompany = function(data){
      $scope.data = true;
      $scope.bids = data.bids;
      $scope.asks = data.asks;
      $scope.userData.orders[$scope.symbol] = data.orders;
      $scope.orders = $scope.userData.orders[$scope.symbol];
      $scope.userData.portfolio[$scope.symbol] = data.portfolio;
      $scope.portfolio = $scope.userData.portfolio[$scope.symbol];
      $scope.updatePrices();
    };
    $scope.updatePrices = function updatePrices(){
      $scope.canPlaceOrder = true;
      var shares = $scope.shares;
      $scope.pricingNotice = "";

      if (!$scope.type||!$scope.price||!$scope.shares){
        $scope.total = "";
        $scope.canPlaceOrder = false;
        return;
      }
      if ($scope.type==="sell"&&shares>$scope.portfolio.shares){
        $scope.total="";
        $scope.canPlaceOrder = false;
        $scope.pricingNotice = "You don't have enough shares to complete this transaction.";
        return;
      }
      var i = 0;
      $scope.total = 0;
      var bids_prices = Object.keys($scope.bids);
      bids_prices.sort(function(a, b) {
        return b - a;
      });
      var asks_prices = Object.keys($scope.asks);
      asks_prices.sort(function(a, b) {
        return a - b;
      });
      if ($scope.type===("buy")){
        while(shares){
          if ($scope.price < asks_prices[i] || !asks_prices[i]){
            $scope.total += shares*$scope.price;
            break;
          }
          if (shares<$scope.asks[asks_prices[i]]){
            $scope.total += asks_prices[i]*$scope.shares;
            break;
          } else {
            shares -= $scope.asks[asks_prices[i]];
            $scope.total += $scope.asks[asks_prices[i]]*asks_prices[i];
            i++;
          }
        }
        if ($scope.total>$scope.userData.cash){
          $scope.canPlaceOrder = false;
          $scope.pricingNotice = "You don't have enough cash to complete this transaction.";
          return;
        }
        if ($scope.price <= bids_prices[0] ) {
          $scope.pricingNotice = "You are not the highest buy order. Your order will be completed after the higher buy orders complete or are cancelled.";
        } else {
          for (let order of $scope.orders){
            if (!order.buy_order && order.price <= $scope.price){
              $scope.pricingNotice = "You have a sell order that's greater in price than this buy order. Please cancel that order first.";
              $scope.canPlaceOrder = false;
              $scope.total = "";
            }
          }
        }
        if (!$scope.pricingNotice && $scope.price >= asks_prices[0]){
          $scope.pricingNotice = "Your order is higher than some sell orders. You will first complete these orders, then, if there are any shares remaining in your order, you will place a buy order for the remainder.";
        }
      } else {
        while(shares){
          if ($scope.price > bids_prices[i] || !bids_prices[i]){
            $scope.total += shares*$scope.price;
            break;
          }
          if (shares<$scope.bids[bids_prices[i]]){
            $scope.total += bids_prices[i]*shares;
            break;
          } else {
            shares -= $scope.bids[bids_prices[i]];
            $scope.total += $scope.bids[bids_prices[i]]*bids_prices[i];
            i++;
          }
        }
        if ($scope.price >= asks_prices[0] ) {
          $scope.pricingNotice = "You are not the lowest sell order. Your order will be completed after the lower sell orders complete or are cancelled.";
        } else {
          for (let order of $scope.orders){
            if (order.buy_order && order.price <= $scope.price){
              $scope.pricingNotice = "You have a buy order that's lower in price than this sell order. Please cancel that order first.";
              $scope.canPlaceOrder = false;
              $scope.total = "";
            }
          }
        }
        if (!$scope.pricingNotice && $scope.price <= bids_prices[0]){
          $scope.pricingNotice = "Your order is lower than some buy orders. You will first complete these orders, then, if there are any shares remaining in your order, you will place a sell order for the remainder.";
        }
      }
    };
    $scope.placeOrder = function(){
      companyFactory.placeOrder({symbol:$scope.symbol, shares:$scope.shares, price:$scope.price}).then(function(){
        $route.reload();
      }).catch(function(err){
        console.err("Error in placeOrder", err);
      });
    };


  }]);

  </script>
</head>

<body ng-controller="outerController">
  <a href="#/" ng-if="home.shouldDisplay">Home</a>
  <a href="#/logout">Log out</a>
  <ng-view></ng-view>

</body>
</html>
